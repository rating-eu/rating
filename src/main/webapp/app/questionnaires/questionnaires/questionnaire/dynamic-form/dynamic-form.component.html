<!--
  ~ Copyright 2019 HERMENEUT Consortium
  ~  
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~  
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~  
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  ~
  -->

<ng-container *ngIf="loading">
    <div class="loader"></div>
</ng-container>

<form *ngIf="form && !loading" (ngSubmit)="submitDispatcher()" [formGroup]="form" role="form"
      class="dynamic-form-component">

    <div [ngSwitch]="role">
        <div *ngSwitchCase="roleEnum.ROLE_CISO">
            <div *ngIf="questionnaire.purpose === purposeEnum.ID_THREAT_AGENT">
                <ol>
                    <li *ngFor="let question of questionsArray; trackBy: trackByID">
                        <div
                            [ngClass]="{'ng-valid': isValid(question.id) === true, 'ng-invalid': isValid(question.id) === false}"
                            class="card-box">

                            <label class="form-control-label" [attr.for]="question?.id">
                                <h5 class="h3-dynamic-form"> {{question?.name}}</h5>
                            </label>
                            <mat-radio-group [formControlName]="question.id" class="radio-group">
                                <mat-radio-button *ngFor="let answer of sort(question.answers)" class="radio-button"
                                                  [value]="answer">
                                    {{answer.name}}
                                </mat-radio-button>
                            </mat-radio-group>
                        </div>
                    </li>
                </ol>
            </div>
            <div *ngIf="questionnaire.purpose === purposeEnum.SELFASSESSMENT">
                <h5 *ngIf="containerType && areaID && area" class="text-center text-primary pt-1">{{area.name}}</h5>
                <p class="text-justify text-dark alert alert-primary" style="font-size: medium">In this section it is possible to
                    review the questions linked to the above <em>Assessment Area</em>.
                    By adjusting the corresponding answers, the current
                    <em>Vulnerability</em> value will be updated accordingly.</p>
                <mat-tab-group [(selectedIndex)]="currentTabIndex">
                    <mat-tab label="Human">
                        <ol *ngIf="humanQuestionsArray">
                            <li *ngFor="let question of humanQuestionsArray; trackBy: trackByID"
                                [ngClass]="{'d-none': containerType && areaID && !(questionAreasMap && questionAreasMap.has(question.id) && questionAreasMap.get(question.id).has(areaID))}"
                            >
                                <div
                                    [ngClass]="{'ng-valid': isValid(question.id) === true, 'ng-invalid': isValid(question.id) === false}"
                                    class="card-box">
                                    <label class="form-control-label" [attr.for]="question?.id">
                                        <h5 class="h3-dynamic-form d-inline"> {{question?.name}}</h5>
                                    </label>
                                    <div class="row">
                                        <div class="bg2" [ngClass]="{'col-md-9': !(containerType && areaID), 'col-md-6': (containerType && areaID)}">
                                            <mat-radio-group [formControlName]="question.id" class="radio-group">
                                                <mat-radio-button *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  [value]="answer">
                                                    {{answer.name}}
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div *ngIf="containerType && areaID" class="col-md-3 text-center" style="margin: auto 0;">
                                            <mat-progress-spinner [diameter]="100" style="margin: 0 auto;"
                                                                  [ngClass]="{
                                              'low': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.2,
                                              'low-medium': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.2 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.4,
                                              'medium': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.4 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.6,
                                              'medium-high': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.6 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.8,
                                              'high': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.8 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 1
                                              }"
                                                                  [value]="answerLikelihoodEnum[form.value[question.id].likelihood]/5 * 100"
                                                                  matTooltip="Vulnerability"
                                                                  [matTooltipPosition]="'above'"
                                            >
                                            </mat-progress-spinner>
                                            <div style="top:-60px; z-index:2;position:relative;">
                                                {{answerLikelihoodEnum[form.value[question.id].likelihood]/5 | percent}}
                                            </div>
                                            <div>
                                                Vulnerability is {{answerLikelihoodEnum[form.value[question.id].likelihood]}}
                                            </div>
                                        </div>
                                        <div class="col-md-3 bg3 text-center">
                                            <mat-form-field>
                                            <textarea matInput [formControlName]="question.id + '.ciso.note'" [rows]="7"
                                                      placeholder="Notes"></textarea>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ol>
                    </mat-tab>

                    <mat-tab label="IT">
                        <ol *ngIf="itQuestionsArray">
                            <li *ngFor="let question of itQuestionsArray; trackBy: trackByID"
                                [ngClass]="{'d-none': containerType && areaID && !(questionAreasMap && questionAreasMap.has(question.id) && questionAreasMap.get(question.id).has(areaID))}"
                            >
                                <div
                                    [ngClass]="{'ng-valid': isValid(question.id) === true, 'ng-invalid': isValid(question.id) === false}"
                                    class="card-box">
                                    <label class="form-control-label" [attr.for]="question?.id">
                                        <h5 class="h3-dynamic-form d-inline"> {{question?.name}}</h5>
                                    </label>
                                    <div class="row">
                                        <div class="bg2" [ngClass]="{'col-md-9': !(containerType && areaID), 'col-md-6': (containerType && areaID)}">
                                            <mat-radio-group [formControlName]="question.id" class="radio-group">
                                                <mat-radio-button *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  [value]="answer">
                                                    {{answer.name}}
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div *ngIf="containerType && areaID" class="col-md-3 text-center" style="margin: auto 0;">
                                            <mat-progress-spinner [diameter]="100" style="margin: 0 auto;"
                                                                  [ngClass]="{
                                              'low': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.2,
                                              'low-medium': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.2 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.4,
                                              'medium': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.4 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.6,
                                              'medium-high': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.6 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.8,
                                              'high': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.8 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 1
                                              }"
                                                                  [value]="answerLikelihoodEnum[form.value[question.id].likelihood]/5 * 100"
                                                                  matTooltip="Vulnerability"
                                                                  [matTooltipPosition]="'above'"
                                            >
                                            </mat-progress-spinner>
                                            <div style="top:-60px; z-index:2;position:relative;">
                                                {{answerLikelihoodEnum[form.value[question.id].likelihood]/5 | percent}}
                                            </div>
                                            <div>
                                                Vulnerability is {{answerLikelihoodEnum[form.value[question.id].likelihood]}}
                                            </div>
                                        </div>
                                        <div class="col-md-3 bg3 text-center">
                                            <mat-form-field>
                                            <textarea matInput [formControlName]="question.id + '.ciso.note'" [rows]="7"
                                                      placeholder="Notes"></textarea>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ol>
                    </mat-tab>

                    <mat-tab label="Physical">
                        <ol *ngIf="physicalQuestionsArray">
                            <li *ngFor="let question of physicalQuestionsArray; trackBy: trackByID"
                                [ngClass]="{'d-none': containerType && areaID && !(questionAreasMap && questionAreasMap.has(question.id) && questionAreasMap.get(question.id).has(areaID))}"
                            >
                                <div
                                    [ngClass]="{'ng-valid': isValid(question.id) === true, 'ng-invalid': isValid(question.id) === false}"
                                    class="card-box">
                                    <label class="form-control-label" [attr.for]="question?.id">
                                        <h5 class="h3-dynamic-form d-inline"> {{question?.name}}</h5>
                                    </label>
                                    <div class="row">
                                        <div class="bg2" [ngClass]="{'col-md-9': !(containerType && areaID), 'col-md-6': (containerType && areaID)}">
                                            <mat-radio-group [formControlName]="question.id" class="radio-group">
                                                <mat-radio-button *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  [value]="answer">
                                                    {{answer.name}}
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div *ngIf="containerType && areaID" class="col-md-3 text-center" style="margin: auto 0;">
                                            <mat-progress-spinner [diameter]="100" style="margin: 0 auto;"
                                                                  [ngClass]="{
                                              'low': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.2,
                                              'low-medium': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.2 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.4,
                                              'medium': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.4 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.6,
                                              'medium-high': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.6 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 0.8,
                                              'high': answerLikelihoodEnum[form.value[question.id].likelihood]/5 > 0.8 && answerLikelihoodEnum[form.value[question.id].likelihood]/5 <= 1
                                              }"
                                                                  [value]="answerLikelihoodEnum[form.value[question.id].likelihood]/5 * 100"
                                                                  matTooltip="Vulnerability"
                                                                  [matTooltipPosition]="'above'"
                                            >
                                            </mat-progress-spinner>
                                            <div style="top:-60px; z-index:2;position:relative;">
                                                {{answerLikelihoodEnum[form.value[question.id].likelihood]/5 | percent}}
                                            </div>
                                            <div>
                                                Vulnerability is {{answerLikelihoodEnum[form.value[question.id].likelihood]}}
                                            </div>
                                        </div>
                                        <div class="col-md-3 bg3 text-center">
                                            <mat-form-field>
                                            <textarea matInput [formControlName]="question.id + '.ciso.note'" [rows]="7"
                                                      placeholder="Notes"></textarea>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ol>
                    </mat-tab>
                </mat-tab-group>
                <mat-tab-group [(selectedIndex)]="currentTabIndex">
                    <mat-tab label="Human">
                    </mat-tab>
                    <mat-tab label="IT">
                    </mat-tab>
                    <mat-tab label="Physical">
                    </mat-tab>
                </mat-tab-group>
            </div>
            <div class="form-row text-right d-block" style="margin-bottom: 40px">
                <button class="btn btn-success waves-light waves-effect w-md" type="submit"
                        [disabled]="!form.valid">
                    <i class="far fa-save"></i>&nbsp;<span>Submit</span>
                </button>
            </div>
        </div>

        <div *ngSwitchCase="roleEnum.ROLE_EXTERNAL_AUDIT">
            <div *ngIf="questionnaire.purpose === purposeEnum.SELFASSESSMENT">
                <mat-tab-group [(selectedIndex)]="currentTabIndex">
                    <mat-tab label="Human">
                        <ol *ngIf="humanQuestionsArray">
                            <li *ngFor="let question of humanQuestionsArray; trackBy: trackByID">
                                <div
                                    [ngClass]="{'ng-valid': isValid(question.id) === true, 'ng-invalid': isValid(question.id) === false}"
                                    class="card-box">
                                    <label class="form-control-label" [attr.for]="question?.id">
                                        <h5 class="h3-dynamic-form"> {{question?.name}}</h5>
                                    </label>
                                    <div class="row">
                                        <div class="col-md-2 bg3 text-center">
                                            <mat-form-field>
                                    <textarea matInput [formControlName]="question.id + '.ciso.note'" [rows]="7"
                                              placeholder="CISO Notes" readonly></textarea>
                                            </mat-form-field>
                                        </div>
                                        <div class="col-md-1 bg1 text-center">
                                            <mat-radio-group [id]="question.id" [formControlName]="question.id"
                                                             class="radio-group">
                                                <mat-radio-button [id]="question.id + '' + answer.id"
                                                                  *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  style="display: flex;  align-items: center;"
                                                                  [value]="answer" disabled="disabled">
                                                    &nbsp;
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div class="col-md-7 bg2">
                                            <mat-radio-group [id]="question.id + '.external'"
                                                             [formControlName]="question.id + '.external'"
                                                             class="radio-group">
                                                <mat-radio-button [id]="question.id + '' + answer.id + '.external'"
                                                                  *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  [value]="answer">
                                                    {{answer.name}}
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div class="col-md-2 bg3 text-center">
                                            <mat-form-field>
                                            <textarea matInput [formControlName]="question.id + '.external.note'" [rows]="7"
                                              placeholder="External Notes"></textarea>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ol>
                    </mat-tab>
                    <mat-tab label="IT">
                        <ol *ngIf="itQuestionsArray">
                            <li *ngFor="let question of itQuestionsArray; trackBy: trackByID">
                                <div
                                    [ngClass]="{'ng-valid': isValid(question.id) === true, 'ng-invalid': isValid(question.id) === false}"
                                    class="card-box">
                                    <label class="form-control-label" [attr.for]="question?.id">
                                        <h5 class="h3-dynamic-form"> {{question?.name}}</h5>
                                    </label>
                                    <div class="row">
                                        <div class="col-md-2 bg3 text-center">
                                            <mat-form-field>
                                    <textarea matInput [formControlName]="question.id + '.ciso.note'" [rows]="7"
                                              placeholder="CISO Notes" readonly></textarea>
                                            </mat-form-field>
                                        </div>
                                        <div class="col-md-1 bg1 text-center">
                                            <mat-radio-group [id]="question.id" [formControlName]="question.id"
                                                             class="radio-group">
                                                <mat-radio-button [id]="question.id + '' + answer.id"
                                                                  *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  style="display: flex;  align-items: center;"
                                                                  [value]="answer" disabled="disabled">
                                                    &nbsp;
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div class="col-md-7 bg2">
                                            <mat-radio-group [id]="question.id + '.external'"
                                                             [formControlName]="question.id + '.external'"
                                                             class="radio-group">
                                                <mat-radio-button [id]="question.id + '' + answer.id + '.external'"
                                                                  *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  [value]="answer">
                                                    {{answer.name}}
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div class="col-md-2 bg3 text-center">
                                            <mat-form-field>
                                            <textarea matInput [formControlName]="question.id + '.external.note'" [rows]="7"
                                              placeholder="External Notes"></textarea>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ol>
                    </mat-tab>
                    <mat-tab label="Physical">
                        <ol *ngIf="physicalQuestionsArray">
                            <li *ngFor="let question of physicalQuestionsArray; trackBy: trackByID">
                                <div
                                    [ngClass]="{'ng-valid': isValid(question.id) === true, 'ng-invalid': isValid(question.id) === false}"
                                    class="card-box">
                                    <label class="form-control-label" [attr.for]="question?.id">
                                        <h5 class="h3-dynamic-form"> {{question?.name}}</h5>
                                    </label>
                                    <div class="row">
                                        <div class="col-md-2 bg3 text-center">
                                            <mat-form-field>
                                            <textarea matInput [formControlName]="question.id + '.ciso.note'" [rows]="7"
                                              placeholder="CISO Notes" readonly></textarea>
                                            </mat-form-field>
                                        </div>
                                        <div class="col-md-1 bg1 text-center">
                                            <mat-radio-group [id]="question.id" [formControlName]="question.id"
                                                             class="radio-group">
                                                <mat-radio-button [id]="question.id + '' + answer.id"
                                                                  *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  style="display: flex;  align-items: center;"
                                                                  [value]="answer" disabled="disabled">
                                                    &nbsp;
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div class="col-md-7 bg2">
                                            <mat-radio-group [id]="question.id + '.external'"
                                                             [formControlName]="question.id + '.external'"
                                                             class="radio-group">
                                                <mat-radio-button [id]="question.id + '' + answer.id + '.external'"
                                                                  *ngFor="let answer of sort(question.answers)"
                                                                  class="radio-button"
                                                                  [value]="answer">
                                                    {{answer.name}}
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div class="col-md-2 bg3 text-center">
                                            <mat-form-field>
                                            <textarea matInput [formControlName]="question.id + '.external.note'" [rows]="7"
                                              placeholder="External Notes"></textarea>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ol>
                    </mat-tab>
                </mat-tab-group>
                <mat-tab-group [(selectedIndex)]="currentTabIndex">
                    <mat-tab label="Human">
                    </mat-tab>
                    <mat-tab label="IT">
                    </mat-tab>
                    <mat-tab label="Physical">
                    </mat-tab>
                </mat-tab-group>
                <div class="form-row text-right d-block" style="margin-bottom: 40px">
                    <button class="btn btn-success waves-light waves-effect w-md" type="submit"
                            [disabled]="!form.valid">
                        <i class="far fa-save"></i>&nbsp;<span>Submit</span>
                    </button>
                </div>
            </div>
        </div>

        <div *ngSwitchDefault>
            <h2>The role {{role}} is not allowed to perform this action</h2>
        </div>
    </div>
</form>
